<canvas id="myCanvas" width="640" height="480" style="border:1px solid #000000;">
</canvas>
<script>
var connection = new WebSocket('ws://192.168.1.19:8888/ws');
connection.onmessage = function (e) {
  console.log('Server: ' + e.data);
};
connection.onopen = function () {
  connection.send('Ping'); // Send the message 'Ping' to the server
};
function getMousePos(canvas, evt) {
  var rect = canvas.getBoundingClientRect();
  return {
    x: evt.clientX - rect.left,
    y: evt.clientY - rect.top
  };
}
var c = document.getElementById("myCanvas");
c.requestPointerLock = c.requestPointerLock ||
  c.mozRequestPointerLock ||
  c.webkitRequestPointerLock;
document.exitPointerLock = document.exitPointerLock ||
  document.mozExitPointerLock ||
  document.webkitExitPointerLock;
/*
document.exitPointerLock = document.exitPointerLock ||
  document.mozExitPointerLock ||
  document.webkitExitPointerLock;
  document.exitPointerLock();
*/
game={}
game.screen={offset:{x:0,y:0},dim:{w:c.width,h:c.height}}
game.cursorAnim={prefix:"hand",time:0,num:0,cols:1,rows:1,end:0,start:0,speed:1,size:{w:150,h:150},ssize:{x:512,y:512}}
game.cursor={canvas:c,anim:game.cursorAnim,pos:{x:0,y:0},locked:false}
function changeCallback(e){

  if(document.pointerLockElement === game.cursor.canvas ||
    document.mozPointerLockElement === game.cursor.canvas ||
    document.webkitPointerLockElement === game.cursor.canvas) {
    game.cursor.locked=true
  } else {
    game.cursor.locked=false
  }
  //game.cursor.pos.x=0
  //game.cursor.pos.y=0
}
document.addEventListener('pointerlockchange', changeCallback, false);
document.addEventListener('mozpointerlockchange', changeCallback, false);
document.addEventListener('webkitpointerlockchange', changeCallback, false);
c.addEventListener('mousemove', function(evt) {
  var dx = evt.movementX ||
    evt.mozMovementX ||
    evt.webkitMovementX ||
    0
  var dy = evt.movementY ||
    evt.mozMovementY ||
    evt.webkitMovementY ||
    0
  if (dx>30)
    dx=30
  if (dy>30)
    dy=30
  if (dx<-30)
    dx=-30
  if (dy<-30)
    dy=-30
  if(game.cursor.locked)
    game.cursor.pos=add(game.cursor.pos, {x:dx,y:dy})
  if(game.cursor.pos.x<0){
    diffX=game.cursor.pos.x
    game.screen.offset.x+=diffX
    game.cursor.pos.x=0
  }
  if(game.cursor.pos.x>game.screen.dim.w){
    diffX=game.cursor.pos.x-game.screen.dim.w
    game.screen.offset.x+=diffX
    game.cursor.pos.x=game.screen.dim.w
  }
  if(game.cursor.pos.y<0){
    diffY=game.cursor.pos.y
    game.screen.offset.y+=diffY
    game.cursor.pos.y=0
  }
  if(game.cursor.pos.y>game.screen.dim.h){
    diffY=game.cursor.pos.y-game.screen.dim.h
    game.screen.offset.y+=diffY
    game.cursor.pos.y=game.screen.dim.h
  }
  //var mousePos = getMousePos(c, evt);
  //var message = 'Mouse position: ' + mousePos.x + ',' + mousePos.y;
}, false);
c.addEventListener('mouseup', function(evt) {
  if(!game.cursor.locked)
    c.requestPointerLock();
  else{
    //var mousePos = getMousePos(c, evt);
    ogre.destType="move"
    ogre.dest.x=game.cursor.pos.x+game.screen.offset.x
    ogre.dest.y=game.cursor.pos.y+game.screen.offset.y
    //var message = 'Mouse position: ' + mousePos.x + ',' + mousePos.y;
  }
});
function getDiff(v1,v2){
  return {x:v2.x-v1.x,y:v2.y-v1.y}
}
function getAng(v){
  return Math.atan2(v.y,v.x)
}
function getLen(v){
  return Math.sqrt(v.x*v.x+v.y*v.y)
}
function scl(v,s){
  return {x:v.x*s,y:v.y*s}
}
function add(v1,v2){
  return {x:v1.x+v2.x,y:v1.y+v2.y}
}
function cpy(v){
  return {x:v.x, y:v.y}
}
function log(v){
  return "{x:"+v.x+", y:"+v.y+"}"
}
function drawAnim(pos,anim,ang,dt,ctx){
  if (ang<0)
    ang+=360
  if (ang>360)
    ang-=360
  imgName=anim.prefix+ang+".png"
  img=loadedImgs[imgName]
  w=anim.ssize.x
  h=anim.ssize.y
  rows=anim.rows
  cols=anim.cols
  if (anim.num<anim.start)
    anim.num=anim.start
  if (anim.num>anim.end)
    anim.num=anim.end
  num=anim.num
  ctx.drawImage(img,img.width/cols*(num%cols)+img.width/cols/2-w/2,img.height/rows*Math.floor(num/cols)+img.height/rows/2-h/2,w,h,pos.x-anim.size.w/2,pos.y-anim.size.h/2,anim.size.w,anim.size.h);
  //anim.num+=1
  //margin=1
  anim.time+=dt
  while(anim.time>=50){
    anim.time-=50
    anim.num++
  }
  looped=false
  if (anim.start!=anim.end){
    while(anim.num>=anim.end){
      anim.num-=(anim.end-anim.start)
      looped=true
    }
  }
  return looped
}
function checkTypes(types,chtypes){
  for (var ti in chtypes){
    var inTypes=false
    for (var tc in types)
      if (chtypes[ti]==types[tc])
        inTypes=true
    if (!inTypes)
      return false
  }
  return true
}
function removeTypes(types,rmTypes){
  for (var ti in rmTypes){
    for (var tc=0;tc<types.length;++tc){
      if (rmTypes[ti]==types[tc]){
        types.splice(tc,1)
        tc-=1
      }
    } 
  }
}
smash = new Audio('smash.ogg');
destroy = new Audio('destroy.ogg');
//imgs=['test.png','testW.png','testW2.png','test180.png']
imgs=['test.png','houseImg0.png','hand0.png','rubble0.png']
ogreAngs=[]
for (var ang=0;ang<360;ang+=45){
  imgName='ogre/ang'+ang+'.png'
  imgs.push(imgName)
  ogreAngs.push(imgName)
}
game.objs=[]
for (var i=0;i<1;++i){
  walkAnim={prefix:"ogre/ang",time:0,num:0,cols:8,rows:6,end:20,start:1,speed:1,size:{w:100,h:100},ssize:{x:128,y:128}}
  standAnim={prefix:"ogre/ang",time:0,num:0,cols:8,rows:6,end:0,start:0,speed:1,size:{w:100,h:100},ssize:{x:128,y:128}}
  attackAnim={prefix:"ogre/ang",time:0,num:0,cols:8,rows:6,end:45,start:21,speed:1,size:{w:100,h:100},ssize:{x:128,y:128}}
  ogre={z:1,maxhp:10,dmg:5,types:['unit','friendly','alive'],anims:{walk:walkAnim,stand:standAnim,attack:attackAnim},anim:standAnim,pos:{x:0,y:0},dest:{x:0,y:0},lastAng:0}
  ogre.hp=ogre.maxhp
  game.objs.push(ogre)
}
for (var i=1;i<5;++i)
{
  anim={prefix:"houseImg",time:0,num:0,cols:1,rows:1,end:0,start:0,speed:1,size:{w:150,h:150},ssize:{x:128,y:128}}
  deadAnim={prefix:"rubble",time:0,num:0,cols:1,rows:1,end:0,start:0,speed:1,size:{w:140,h:70},ssize:{x:164,y:107}}
  house={z:-1,maxhp:30,types:['building','enemy','alive'],anims:{dead:deadAnim,stand:anim},pos:{x:140*i,y:140*i},dest:{x:40,y:40},lastAng:0}
  house.hp=house.maxhp
  game.objs.push(house)
}
imgsLoaded=0
loadedImgs={}
for (s in imgs){
  var img = new Image();
  img.src=imgs[s];
  img.onload=function(){
    imgsLoaded++
    console.log("cur: "+imgsLoaded+", tot: "+imgs.length)
    if (imgsLoaded==imgs.length)
      loop()
  };
  loadedImgs[imgs[s]]=img;
}
//num=1
//which=0
lastTime=0
function loop(){
  requestAnimationFrame(loop);
  var curTime=new Date().getTime();
  if (lastTime==0)
    lastTime=curTime
  var dt=curTime-lastTime
  lastTime=curTime
  var c = document.getElementById("myCanvas");
  var ctx = c.getContext("2d");
  ctx.clearRect(0, 0, c.width, c.height);
  /*
  ctx.beginPath();
  ctx.arc(95,50,40,0,2*Math.PI);
  ctx.stroke();
  */
  //ctx.drawImage(loadedImgs['test.png'],20,20,40,40,10,10,70,70);
  //walks=['testW.png','testW2.png','test180.png']
  for (var i=0;i<game.objs.length-1;++i){
    var o1=game.objs[i]
    var o2=game.objs[i+1]
    if(o2.z<o1.z){
      //swap
      game.objs[i]=o2
      game.objs[i+1]=o1
      if(i>0)
        i-=1
    }
  }
  for (var i in game.objs){
    var obj=game.objs[i]
    //walks=ogreAngs
    //img=loadedImgs[walks[Math.floor(which/2)%walks.length]]
    //img=loadedImgs[ogreAngs[0]]
    attacking=false
    if(checkTypes(obj.types,['alive'])){
      if (obj.hp<=0){
        destroy.play()
        removeTypes(obj.types,['alive'])
        obj.anim=obj.anims.dead
      }
    }
    if(checkTypes(obj.types,['alive'])){
      var diff={x:0,y:0}
      if(obj.destType=="move"){
        diff=getDiff(obj.pos,obj.dest)
      }else
      if(obj.destType=="attack"){
        if(checkTypes(obj.dest.types,['alive']))
          diff=getDiff(obj.pos,obj.dest.pos)
        else{
          obj.destType="move"
          obj.dest=cpy(obj.pos)
        }
      }
      var len=getLen(diff)
      if (obj.destType=="attack" && len < 60){//should calc target size and this range to see if we're in range
        attacking=true
        obj.anim=obj.anims.attack
        var ang=getAng(diff)/Math.PI*180
        ang=(Math.round(ang/45)*45-90)
        obj.lastAng=ang
      }else
      if (len>10){
        //reset attack:
        obj.anims.attack.num=0
        obj.anims.attack.time=0
        var nor=scl(diff,1/len)
        nor=scl(nor,dt*(1/30))
        obj.pos=add(obj.pos,nor)
        var ang=getAng(nor)/Math.PI*180
        ang=(Math.round(ang/45)*45-90)
        obj.lastAng=ang
        obj.anim=obj.anims.walk
      }else{
        if(checkTypes(obj.types,['unit','friendly'])){
          bestTarget=null
          for (var c=0;c<game.objs.length;++c){
            if(c!=i){
              var objc=game.objs[c]
              if(checkTypes(objc.types,['enemy','alive'])){
                var diff=getDiff(obj.pos,objc.pos)
                var len=getLen(diff)
                if(bestTarget==null||len<bestTarget.len){
                  bestTarget={obj:objc,len:len}
                }
              }
            }
            if(bestTarget!=null&&bestTarget.len<300){
              obj.destType="attack"
              obj.dest=bestTarget.obj
            }
          }
        }
        obj.anim=obj.anims.stand
      }
    }
    ang=obj.lastAng
    var looped=drawAnim(add(obj.pos,scl(game.screen.offset,-1)),obj.anim,ang,dt,ctx)
    if(looped&&attacking){
      smash.play()
      obj.dest.hp-=obj.dmg
    }
    //if (obj.anim.num+margin==obj.anim.end){
    //  obj.anim.num=1
      //which++
    //}
  }
  drawAnim(game.cursor.pos,game.cursor.anim,0,dt,ctx)
  
}
var ogg = new Audio('test.ogg');
//ogg.src="test.ogg";
//ogg.oncanplay=function(){
//ogg.oncanplaythrough=function(){
ogg.onloadeddata=function(){
  ogg.play();
}
</script>
